<!DOCTYPE html>
<html>

<head>
    <style>
        .tabuleiro {
            width: 500px;
            height: 500px;
            flex-direction: column;
            position: relative;
            border: 1px solid;
        }

        .casa {
            width: 12.5%;
            height: 12.5%;
            float: left;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .casa.on {
            background: rgb(151, 252, 184) !important;
        }

        .casa.select {
            position: relative;
            overflow: hidden;
            background-image: url('./pecas/alvo.png') !important;
            background-repeat: no-repeat, repeat !important;
            background-size: 48px 48px !important;
            background-position: center !important;
        }

        .casa.comer {
            /* background: rgb(80, 113, 94) !important; */
            background: rgba(255, 0, 0, 0.14) !important
        }

        .trigonometria:before {
            content: ' ';
            display: block;
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            /* z-index: 1; */
            opacity: 0.6;
        }

        .casa.clara {
            background: white;
        }

        .casa.escura {
            background: #557377;
        }

        .peca {
            width: 20px;
            /* height: 47%; */
        }

        .peca.media {
            width: 27px;
            height: 56px;
        }

        .peca.grande {
            width: 50%;
            height: 60%;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
</head>

<body>

    <div class="tabuleiro">
    </div>

    <script>
        let coluns = ['a', 'b', 'c', 'd', 'e', 'f', 'g', 'h'];
        let movimentos = [];

        for (let i = 0; i < 8; i++) {
            let cors = ['escura', 'clara'];
            let cor = i % 2 == 0 ? 0 : 1;
            for (let j = 0; j < 8; j++) {
                $('.tabuleiro').append(
                    `<div class="casa ${cors[cor]}" ondrop="drop(event)" ondragover="allowDrop(event)"` +
                    ` data-col="${j + 1}" data-row="${i + 1}" data-pos="${i + 1}-${j + 1}"></div>`
                )
                cor = cor == 1 ? 0 : 1;
            }
        }

        peao();
        pecasMedias();

        $(`[data-pos="5-5"]`)
            .html(html('clara', 10, 'bispo', `5-5`));

        function html(cor, id, tipo, pos, tam) {
            return `<img id="${tipo}-${cor}-${id}"` +
                ` src="./pecas/${tipo}${cor != 'clara' ? 2 : ''}.png"` +
                ' draggable="true"' +
                ' ondragstart="drag(event)"' +
                ` data-pos="${pos}"` +
                ` data-tipo="${tipo}"` +
                ` data-cor="${cor}"` +
                ` class="peca ${cor} ${tam}">`
        }

        function peao() {
            for (let p = 0; p < 8; p++) {
                $(`[data-pos="2-${p + 1}"]`)
                    .html(html('clara', p, 'peao', `2-${p + 1}`));
            }
            for (let p = 0; p < 8; p++) {
                $(`[data-pos="7-${p + 1}"]`)
                    .html(html('escura', p, 'peao', `7-${p + 1}`));
            }
        }

        function pecasMedias() {
            let pc = {
                torre: [`1-1`, `1-8`, `8-1`, `8-8`],
                cavalo: [`1-2`, `1-7`, `8-2`, `8-7`],
                bispo: [`1-3`, `1-6`, `8-3`, `8-6`]
            }
            Object.keys(pc).forEach(x => {
                pc[x].forEach((y, i) => {
                    $(`[data-pos="${y}"]`).html(html(i < 2 ? 'clara' : 'escura', i, x, y, 'media'));
                })
            });
        }

        function resetMovs() {
            $(`.casa`).removeClass('on')
            $(`.casa`).removeClass('select');
            $(`.casa`).removeClass('comer');
        }

        let jogadas = {
            peao: (element) => {
                resetMovs();
                let isClara = $(element).attr(`data-cor`) == 'clara';
                let pos = $(element).attr('data-pos').split('-');

                let movs = [
                    {
                        r: +pos[0] + (isClara ? 1 : -1),
                        c: +pos[1],
                        t: 'mov'
                    }, {
                        r: isClara ? +pos[0] + 1 : +pos[0] - 1,
                        c: +pos[1] + 1,
                        t: 'atk'
                    }, {
                        r: isClara ? +pos[0] + 1 : +pos[0] - 1,
                        c: +pos[1] - 1,
                        t: 'atk'
                    }
                ];

                movs.forEach(x => {
                    let casa = $(`.casa[data-pos="${x.r}-${x.c}"]`);
                    if (x.t == 'mov') {
                        if (!casa.html()) {
                            casa.addClass('select');
                            movimentos.push(x);
                        }
                    } else {
                        if (casa.html() && $(element).attr(`data-cor`) != casa.find('img').attr(`data-cor`)) {
                            casa.addClass('comer');
                            movimentos.push(x);
                        }
                    }
                });

                if (movimentos.length)
                    $(element).closest(`.casa`).addClass('on');
            },
            torre: (element) => {
                resetMovs();
                let isClara = $(element).attr(`data-cor`) == 'clara';
                let pos = $(element).attr('data-pos').split('-');
                let movs = [];

                for (let p = 0; p < 2; p++) {
                    for (let value = 1; value < 9; value++) {
                        if (value == (p % 2 == 0 ? +pos[0] : +pos[1])) continue;
                        movs.push({
                            r: p % 2 == 0 ? value : +pos[0],
                            c: p % 2 == 0 ? +pos[1] : value,
                            t: p % 2 == 0 ? 'row' : 'col'
                        })
                    }
                }

                function find(mov) {
                    let isRow = mov.t == 'row';
                    let r = {
                        start: +pos[isRow ? 0 : 1],
                        end: mov[isRow ? 'r' : 'c']
                    };
                    let casa;
                    let ocupadas = [];

                    if (r.start > r.end) {
                        for (let p = r.start - 1; p > r.end; p--) {
                            casa = isRow
                                ? $(`.casa[data-pos="${p}-${mov.c}"]`)
                                : $(`.casa[data-pos="${mov.r}-${p}"]`);
                            if (casa.html()) ocupadas.push(1);
                        }
                    } else {
                        for (let p = r.start + 1; p < r.end; p++) {
                            casa = isRow
                                ? $(`.casa[data-pos="${p}-${mov.c}"]`)
                                : $(`.casa[data-pos="${mov.r}-${p}"]`);
                            if (casa.html()) ocupadas.push(1);
                        }
                    }
                    let img = $(`.casa[data-pos="${mov.r}-${mov.c}"]`).find('img');

                    if (
                        ocupadas.length ||
                        $(img).attr('data-cor') == $(element).attr('data-cor')
                    ) return false;

                    mov.a = img.length
                        ? 'atk' : 'mov';

                    return mov;
                }

                movs.forEach(x => {
                    let mov = find(x);
                    if (!mov) return;
                    let casa = $(`.casa[data-pos="${mov.r}-${mov.c}"]`);
                    if (mov.a == 'mov') {
                        casa.addClass('select');
                        movimentos.push(mov);
                    } else {
                        casa.addClass('comer');
                        movimentos.push(mov);
                    }
                });

                if (movimentos.length)
                    $(element).closest(`.casa`).addClass('on');
            },
            cavalo: (element) => {
                resetMovs();
                let isClara = $(element).attr(`data-cor`) == 'clara';
                let pos = $(element).attr('data-pos').split('-').map(Number);
                let movs = [];

                for (let k = 0; k < 2; k++) { // esqueda | direita
                    for (let p = 0; p < 2; p++) { // cima | baixo
                        for (let q = 0; q < 2; q++) { // jg1 | jg2
                            movs.push({
                                r: pos[0] + ((q % 2 == 0 ? 1 : 2) * (p % 2 == 0 ? -1 : 1)),
                                c: pos[1] + ((q % 2 == 0 ? 2 : 1) * (k % 2 == 0 ? -1 : 1))
                            });
                        }
                    }
                }

                movs.forEach(x => {
                    let casa = $(`.casa[data-pos="${x.r}-${x.c}"]`);
                    if (!casa.html()) {
                        casa.addClass('select');
                        movimentos.push(x);
                        return;
                    }
                    if ($(element).attr('data-cor') == casa.find('img').attr('data-cor'))
                        return;

                    casa.addClass('comer');
                    movimentos.push(x);
                });

                if (movimentos.length)
                    $(element).closest(`.casa`).addClass('on');
            },
            bispo: (element) => {
                resetMovs();
                let isClara = $(element).attr(`data-cor`) == 'clara';
                let pos = $(element).attr('data-pos').split('-').map(Number);
                let movs = [];

                for (let p = 0; p < 4; p++) {
                    let cond = true;
                    let r = pos[0];
                    let c = pos[1];
                    while (cond) {
                        r += p < 2
                            ? p % 2 == 0 ? -1 : 1
                            : p % 2 == 0 ? -1 : 1;
                        c += p < 2
                            ? p % 2 == 0 ? -1 : 1
                            : p % 2 == 0 ? 1 : -1;
                        if (
                            (p == 0 && r > 0 && c > 0) ||
                            (p == 1 && r < 9 && c < 9) ||
                            (p == 2 && r > 0 && c < 9) ||
                            (p == 3 && r < 9 && c > 0)
                        )
                            movs.push({ r, c });
                        else
                            cond = false;
                    }
                }

                console.log(movs)

                function find(mov) {
                    let r = {
                        start: pos[0] > mov.r ? mov.r : pos[0],
                        end: pos[0] > mov.r ? pos[0] : mov.r
                    };
                    let casa;
                    let ocupadas = [];
                    let col = pos[0] > mov.r ? mov.c : pos[1];
                    let multi = pos[0] > mov.r 
                        ? mov.c > pos[1] ? -1 : 1 
                        : pos[1] > mov.c ? -1 : 1;

                    for (let p = r.start + 1; p < r.end; p++) {
                        col += (1 * multi);
                        casa = $(`.casa[data-pos="${p}-${col}"]`);
                        if (casa.html() && casa.html().trim()) {
                            ocupadas.push(1)
                        };
                    }

                    let img = $(`.casa[data-pos="${mov.r}-${mov.c}"]`).find('img');

                    if (
                        ocupadas.length ||
                        $(img).attr('data-cor') == $(element).attr('data-cor')
                    ) return false;

                    mov.a = img.length
                        ? 'atk' : 'mov';

                    return mov;
                }

                movs.forEach(x => {
                    let mov = find(x);
                    if (!mov) return;
                    let casa = $(`.casa[data-pos="${mov.r}-${mov.c}"]`);
                    if (mov.a == 'mov') {
                        casa.addClass('select');
                        movimentos.push(mov);
                    } else {
                        casa.addClass('comer');
                        movimentos.push(mov);
                    }
                });

                if (movimentos.length)
                    $(element).closest(`.casa`).addClass('on');
            }
        }

        $(document).on('mousedown', '.peca', function () {
            movimentos = [];
            jogadas[$(this).attr('data-tipo')](this);
        });

        function allowDrop(ev) {
            ev.preventDefault();
        }

        function drag(ev) {
            if (!movimentos.length)
                return ev.preventDefault();
            ev.dataTransfer.setData("text", ev.target.id);
        }

        function drop(ev) {
            ev.preventDefault();
            var data = ev.dataTransfer.getData("text");

            let elem = $(ev.target).hasClass('casa')
                ? $(ev.target)
                : $(ev.target).closest('casa');

            let pos = elem.attr('data-pos').split('-');

            let casa = movimentos.find(x => +x.r == +pos[0] && +x.c == +pos[1]);

            if (!casa)
                return ev.preventDefault();

            let pc = document.getElementById(data);

            $(pc).attr('data-pos', pos.join('-'));

            $(ev.target).html(pc);
            resetMovs();
        }

    </script>
</body>

</html>